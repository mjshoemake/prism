<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics Dashboard - Purple & Black Theme</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom Purple & Black Theme -->
    <link rel="stylesheet" href="purple-black-theme.css">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-bar me-2"></i>Metrics Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="theme-demo.html">
                    <i class="fas fa-palette me-1"></i>Theme Demo
                </a>
                <a class="nav-link" href="charts-demo.html">
                    <i class="fas fa-chart-line me-1"></i>Charts Demo
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <div id="metrics-dashboard"></div>
    </div>

    <!-- React Component -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MetricsDashboard = () => {
            const [focusAreas, setFocusAreas] = useState([]);
            const [focusLevels, setFocusLevels] = useState([]);
            const [selectedFocusArea, setSelectedFocusArea] = useState(null);
            const [selectedFocusLevel, setSelectedFocusLevel] = useState(null);
            const [chartData, setChartData] = useState([]);
            const [filters, setFilters] = useState([]); // [{name, column_name, value}]
            const [snackbar, setSnackbar] = useState(null); // {message, variant}

            const showSnackbar = (message, variant = 'info') => {
                setSnackbar({ message, variant });
                window.clearTimeout(showSnackbar._t);
                showSnackbar._t = window.setTimeout(() => setSnackbar(null), 2500);
            };
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [chartError, setChartError] = useState(null);
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);

            // Purple theme colors
            const purpleTheme = {
                primary: '#6f42c1',
                primaryDark: '#5a2d9e',
                primaryLight: '#8b5fd6',
                accent: '#8e44ad',
                textLight: '#e6d9f2',
                textMuted: '#b8a9d9',
                white: '#ffffff'
            };

            // Fetch focus areas on component mount
            useEffect(() => {
                fetchFocusAreas();
            }, []);

            // Fetch focus levels when focus area changes
            useEffect(() => {
                if (selectedFocusArea) {
                    fetchFocusLevels(selectedFocusArea.focus_area_pk);
                }
            }, [selectedFocusArea]);

            // Fetch chart data when focus level changes
            useEffect(() => {
                if (selectedFocusLevel) {
                    fetchChartData();
                }
            }, [selectedFocusLevel, filters]);

            // Update chart when data changes
            useEffect(() => {
                if (chartData.length > 0 && chartRef.current) {
                    updateChart();
                }
            }, [chartData]);

            const fetchFocusAreas = async () => {
                try {
                    setLoading(true);
                    const response = await fetch('http://localhost:8080/api/metrics/focus-areas-list');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    setFocusAreas(data);
                    if (data.length > 0) {
                        setSelectedFocusArea(data[0]);
                    }
                } catch (err) {
                    setError(`Failed to fetch focus areas: ${err.message}`);
                    console.error('Error fetching focus areas:', err);
                } finally {
                    setLoading(false);
                }
            };

            const fetchFocusLevels = async (focusAreaPk) => {
                try {
                    setLoading(true);
                    const response = await fetch(`http://localhost:8080/api/metrics/focus-levels-list/${focusAreaPk}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    setFocusLevels(data);
                    if (data.length > 0) {
                        setSelectedFocusLevel(data[0]);
                    }
                } catch (err) {
                    setError(`Failed to fetch focus levels: ${err.message}`);
                    console.error('Error fetching focus levels:', err);
                } finally {
                    setLoading(false);
                }
            };

            const fetchChartData = async () => {
                if (!selectedFocusLevel) return;

                try {
                    setLoading(true);
                    setChartError(null); // Clear previous chart errors
                    // Build whereClause from filters
                    const whereParts = filters.map(f => {
                        const safeVal = String(f.value).replace(/'/g, "''");
                        return `${f.column_name} = '${safeVal}'`;
                    });
                    const whereClauseBuilt = whereParts.length > 0 ? `WHERE ${whereParts.join(' and ')}` : "";
                    const requestBody = {
                        focusLevelColumn: selectedFocusLevel.column_name,
                        valueColumnsForSelectClause: 'ROUND((SUM(smf.committed_story_points_completed)::DECIMAL / SUM(smf.committed_story_points)::DECIMAL) * 100, 2) as "Say/Do Ratio"',
                        whereClause: whereClauseBuilt
                    };

                    console.log('Sending POST request to /api/metrics/sprint-metrics with body:', requestBody);
                    
                    const response = await fetch('http://localhost:8080/api/metrics/sprint-metrics', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error response body:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('Chart data received:', data);
                    setChartData(data);
                } catch (err) {
                    setChartError(`Failed to fetch chart data: ${err.message}`);
                    console.error('Error fetching chart data:', err);
                    setChartData([]); // Clear chart data on error
                } finally {
                    setLoading(false);
                }
            };

            const updateChart = () => {
                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }

                const ctx = chartRef.current.getContext('2d');
                const labels = chartData.map(item => {
                    // Get the value from the focus level column
                    const focusLevelValue = item[selectedFocusLevel.column_name];
                    return focusLevelValue || 'Unknown';
                });
                const values = chartData.map(item => item['Say/Do Ratio'] || 0);

                chartInstanceRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Say/Do Ratio (%)',
                            data: values,
                            backgroundColor: purpleTheme.primary,
                            borderColor: purpleTheme.primaryDark,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: purpleTheme.white,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    afterBody: (items) => {
                                        if (!items || items.length === 0) return '';
                                        const label = items[0].label;
                                        return `Filter on: ${selectedFocusLevel?.name} = ${label}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: purpleTheme.textMuted,
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                grid: {
                                    color: purpleTheme.secondary
                                }
                            },
                            x: {
                                ticks: {
                                    color: purpleTheme.textMuted
                                },
                                grid: {
                                    color: purpleTheme.secondary
                                }
                            }
                        }
                    }
                });

                // Click handler to add filter based on clicked bar
                const canvas = chartRef.current;
                canvas.onclick = (evt) => {
                    if (!chartInstanceRef.current) return;
                    const points = chartInstanceRef.current.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
                    if (points.length) {
                        const first = points[0];
                        const label = chartInstanceRef.current.data.labels[first.index];
                        if (!label) return;
                        setFilters(prev => {
                            const exists = prev.some(f => f.column_name === selectedFocusLevel.column_name && String(f.value) === String(label));
                            if (exists) {
                                showSnackbar('Filter already exists', 'warning');
                                return prev;
                            }
                            showSnackbar(`Added filter: ${selectedFocusLevel.name} = ${label}`, 'success');
                            return [...prev, { name: selectedFocusLevel.name, column_name: selectedFocusLevel.column_name, value: label }];
                        });
                    }
                };
            };

            const handleFocusAreaChange = (event) => {
                const selectedPk = parseInt(event.target.value);
                const selected = focusAreas.find(area => area.focus_area_pk === selectedPk);
                setSelectedFocusArea(selected);
                setSelectedFocusLevel(null);
                setChartData([]);
                setFilters([]); // reset filters when focus area changes
            };

            const handleFocusLevelChange = (event) => {
                const selectedColumn = event.target.value;
                const selected = focusLevels.find(level => level.column_name === selectedColumn);
                setSelectedFocusLevel(selected);
            };

            if (loading && focusAreas.length === 0) {
                return (
                    <div className="container">
                        <div className="row justify-content-center">
                            <div className="col-md-6">
                                <div className="card shadow-purple">
                                    <div className="card-body text-center">
                                        <div className="spinner-border text-primary" role="status">
                                            <span className="visually-hidden">Loading...</span>
                                        </div>
                                        <p className="mt-3 text-muted">Loading focus areas...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="container">
                        <div className="row justify-content-center">
                            <div className="col-md-6">
                                <div className="alert alert-danger" role="alert">
                                    <i className="fas fa-exclamation-triangle me-2"></i>
                                    {error}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <div className="row mb-4">
                        <div className="col-12">
                            <h2 className="text-light-purple mb-4">
                                <i className="fas fa-chart-bar me-2"></i>Say/Do Ratio Metrics
                            </h2>
                        </div>
                    </div>

                    {/* Picklists */}
                    <div className="row mb-4">
                        <div className="col-md-6">
                            <div className="card shadow-purple">
                                <div className="card-header">
                                    <h5 className="mb-0">
                                        <i className="fas fa-list me-2"></i>Focus Area
                                    </h5>
                                </div>
                                <div className="card-body">
                                    <select 
                                        className="form-select" 
                                        value={selectedFocusArea?.focus_area_pk || ''}
                                        onChange={handleFocusAreaChange}
                                        disabled={loading}
                                    >
                                        {focusAreas.map(area => (
                                            <option key={area.focus_area_pk} value={area.focus_area_pk}>
                                                {area.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div className="col-md-6">
                            <div className="card shadow-purple">
                                <div className="card-header">
                                    <h5 className="mb-0">
                                        <i className="fas fa-layer-group me-2"></i>Focus Level
                                    </h5>
                                </div>
                                <div className="card-body">
                                    <select 
                                        className="form-select" 
                                        value={selectedFocusLevel?.column_name || ''}
                                        onChange={handleFocusLevelChange}
                                        disabled={loading || !selectedFocusLevel}
                                    >
                                        {focusLevels.map(level => (
                                            <option key={level.column_name} value={level.column_name}>
                                                {level.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Chart */}
                    <div className="row">
                        <div className="col-12">
                            <div className="card shadow-purple">
                                <div className="card-header">
                                    <h5 className="mb-0">
                                        <i className="fas fa-chart-bar me-2"></i>
                                        Say/Do Ratio by {selectedFocusLevel?.name || 'Focus Level'}
                                    </h5>
                                </div>
                                <div className="card-body">
                                    {/* Active Filters */}
                                    <div className="mb-3">
                                        <div className="d-flex align-items-center justify-content-between mb-2">
                                            <h6 className="text-light-purple mb-0"><i className="fas fa-filter me-2"></i>Active Filters</h6>
                                            {filters.length > 0 && (
                                                <button className="btn btn-sm btn-outline-secondary" onClick={() => { setFilters([]); showSnackbar('Cleared all filters', 'info'); }}>
                                                    Clear all
                                                </button>
                                            )}
                                        </div>
                                        {filters.length === 0 ? (
                                            <p className="text-muted mb-2">No filters applied. Click a bar to add a filter.</p>
                                        ) : (
                                            <ul className="list-group mb-3">
                                                {filters.map((f, idx) => (
                                                    <li className="list-group-item d-flex justify-content-between align-items-center" key={`${f.column_name}-${idx}`}>
                                                        <span><strong>{f.name}:</strong> {f.value}</span>
                                                        <button className="btn btn-sm btn-outline-secondary" onClick={() => {
                                                            setFilters(prev => prev.filter((_, i) => i !== idx));
                                                            showSnackbar(`Removed filter: ${f.name} = ${f.value}`, 'info');
                                                        }}>Remove</button>
                                                    </li>
                                                ))}
                                            </ul>
                                        )}
                                    </div>
                                    {chartError ? (
                                        <div className="alert alert-danger" role="alert">
                                            <i className="fas fa-exclamation-triangle me-2"></i>
                                            {chartError}
                                            <br/><br/>
                                            <small className="text-muted">
                                                Check the browser console (F12) for more detailed error information.
                                            </small>
                                        </div>
                                    ) : loading ? (
                                        <div className="text-center py-5">
                                            <div className="spinner-border text-primary" role="status">
                                                <span className="visually-hidden">Loading...</span>
                                            </div>
                                            <p className="mt-3 text-muted">Loading chart data...</p>
                                        </div>
                                    ) : chartData.length === 0 ? (
                                        <div className="text-center py-5">
                                            <i className="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                            <p className="text-muted">No data available for the selected criteria.</p>
                                        </div>
                                    ) : (
                                        <div style={{ height: '400px' }}>
                                            <canvas ref={chartRef}></canvas>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Debug Info (remove in production) */}
                    <div className="row mt-4">
                        <div className="col-12">
                            <div className="card shadow-purple">
                                <div className="card-header">
                                    <h6 className="mb-0">Debug Information</h6>
                                </div>
                                <div className="card-body">
                                    <div className="row">
                                        <div className="col-md-4">
                                            <strong>Selected Focus Area:</strong><br/>
                                            <code>{selectedFocusArea ? JSON.stringify(selectedFocusArea, null, 2) : 'None'}</code>
                                        </div>
                                        <div className="col-md-4">
                                            <strong>Selected Focus Level:</strong><br/>
                                            <code>{selectedFocusLevel ? JSON.stringify(selectedFocusLevel, null, 2) : 'None'}</code>
                                        </div>
                                        <div className="col-md-4">
                                            <strong>Chart Data Count:</strong><br/>
                                            <code>{chartData.length} records</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {snackbar && (
                        <div className={`alert ${snackbar.variant === 'success' ? 'alert-success' : snackbar.variant === 'warning' ? 'alert-warning' : 'alert-info'} shadow-purple position-fixed`} role="alert" style={{ bottom: '1rem', right: '1rem', zIndex: 1080 }}>
                            {snackbar.message}
                        </div>
                    )}
                </div>
            );
        };

        // Render the component using React 18 createRoot
        const root = ReactDOM.createRoot(document.getElementById('metrics-dashboard'));
        root.render(<MetricsDashboard />);
    </script>
</body>
</html>
